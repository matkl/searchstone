!function(){"use strict";function e(e){b.settings.debug&&console.log(e)}function t(){return T.length?T.pop():document.createElement("canvas")}function r(e){T.push(e)}function i(r){if(e("Substitute for "+r),m)return m;var i=t(),a=i.getContext("2d");return i.width=i.height=512,a.save(),a.fillStyle="grey",a.fillRect(0,0,512,512),a.fill(),a.fillStyle="red",a.textAlign="center",a.textBaseline="middle",a.font="50px Belwe",a.fillText("missing artwork",256,256),a.restore(),m=new Image,m.src=i.toDataURL(),m}function a(e){return v[e]||i(e)}function n(e){var t,r,i="",a=305419896;for(r in e)i=i+r+e[r];for(t=0;t<i.length;t++)a+=i.charCodeAt(t)*(t+1);return a}function s(e,t,r,i,a){var n=.5522848,s=i/2*n,o=a/2*n,l=t+i,d=r+a,h=t+i/2,g=r+a/2;e.beginPath(),e.moveTo(t,g),e.bezierCurveTo(t,g-o,h-s,r,h,r),e.bezierCurveTo(h+s,r,l,g-o,l,g),e.bezierCurveTo(l,g+o,h+s,d,h,d),e.bezierCurveTo(h-s,d,t,g+o,t,g),e.stroke()}function o(t){return new Promise(function(r){for(var a,n,s,o,l,d=0,h=1,g={},u=0;u<t.length;u++)a=t[u],n=!1,s=!1,"h:"===a.substr(0,2)&&(n=!0,s=!!b.settings.smallTextureFolder,a=a.substr(2)),"t:"===a.substr(0,2)&&(n=!0,a=a.substr(2),void 0!==v[a]&&256===v[a].width&&(v[a]=void 0)),"u:"===a.substr(0,2)&&(o=!0,a=a.substr(2)),void 0===v[a]?(v[a]=new Image,v[a].crossOrigin="Anonymous",v[a].loaded=!1,h++,function(e){v[e].addEventListener("load",function(){d++,v[e].loaded=!0,g[e]=v[e],v[e].width&&v[e].height||(v[e].src=i().src),d>=h&&r(g)}),v[e].addEventListener("error",function(){d++,v[e].src=i().src,v[e].loaded=!0,g[e]=v[e],d>=h&&r(g)})}(a),o?v[a].src=a:(n?(v[a].isTexture=!0,l=s?b.settings.smallTextureFolder+a+".jpg":b.settings.textureFolder+a+".jpg"):l=b.settings.assetFolder+a+".png",e("Requesting "+l),v[a].src=l)):(h++,v[a].loaded?(d++,g[a]=v[a]):!function(e){v[e].addEventListener("load",function(){d++,g[e]=v[e],d>=h&&r(g)})}(a));h--,d>0&&d>=h&&r(g)})}function l(e){var t,r,i=e.canvas.width,a=e.canvas.height,n=e.getImageData(0,0,i,a).data,s=999,o=999,l=0,d=0,h=!1;for(r=a-1;r>-1&&!h;r--)for(t=0;i>t;t++)if(n[r*(4*i)+4*t+3]>0){d=Math.max(d,r),h=!0;break}if(void 0===d)return null;e:for(t=i-1;t>-1;t--)for(r=0;a>r;r++)if(n[r*(4*i)+4*t+3]>0){l=Math.max(l,t);break e}e:for(t=0;l>t;t++)for(r=0;a>r;r++)if(n[r*(4*i)+4*t+3]>0){s=Math.min(t,s);break e}e:for(r=0;d>r;r++)for(t=0;i>t;t++)if(n[r*(4*i)+4*t+3]>0){o=Math.min(o,r);break e}return{x:s,y:o,maxX:l,maxY:d,w:l-s,h:d-o}}function d(e,i,a){var n,s;n=b.races[a.language]?b.races[a.language][a.race]?b.races[a.language][a.race]:a.race:b.races.enUS[a.race]?b.races.enUS[a.race]:a.race;var o=t(),d=o.getContext("2d");o.width=300,o.height=60,d.font="45px Belwe",d.lineCap="round",d.lineJoin="round",d.textBaseline="hanging",d.textAlign="left",n=n.split(""),s=10;for(var h=0;h<n.length;h++)d.lineWidth=8,d.strokeStyle="black",d.fillStyle="black",d.fillText(n[h],s,10),d.strokeText(n[h],s,10),d.fillStyle="white",d.strokeStyle="white",d.lineWidth=1,d.fillText(n[h],s,10),s+=d.measureText(n[h]).width;var g=l(d);e.drawImage(o,g.x,g.y,g.w,g.h,(394-g.w/2)*i,(1001-g.h/2)*i,g.w*i,g.h*i),r(o)}function h(e,i,a,n,s,o,d){var h=t(),g=h.getContext("2d");void 0===d&&(d="0"),h.width=256,h.height=256,s=s.toString(),s=s.split("");var u=10;g.font=o+"px Belwe",g.lineCap="round",g.lineJoin="round",g.textBaseline="hanging",g.textAlign="left";var w="white";"-"===d&&(w="#f00"),"+"===d&&(w="#0f0");for(var c=0;c<s.length;c++)g.lineWidth=13,g.strokeStyle="black",g.fillStyle="black",g.fillText(s[c],u,10),g.strokeText(s[c],u,10),g.fillStyle=w,g.strokeStyle=w,g.lineWidth=2.5,g.fillText(s[c],u,10),u+=g.measureText(s[c]).width;var y=l(g);e.drawImage(h,y.x,y.y,y.w,y.h,(i-y.w/2)*n,(a-y.h/2)*n,y.w*n,y.h*n),r(h)}function g(e,t,r,i,a,n){b.settings.debug&&(e.save(),e.strokeStyle="red",e.beginPath(),e.moveTo(n/2-i/2,a),e.lineTo(n/2+i/2,a),e.stroke(),e.restore());var s=n/2-i/2;return 0>s&&(s=0),i>0&&t.width>0&&e.drawImage(t,0,0,i>t.width?t.width:i,t.height,s,a,Math.min(i,t.width),t.height),i=5,a+=t.height,r.clearRect(0,0,t.width,t.height),[i,a]}function u(i,a,n,s){var o,d,h,w,c,y,f,x,p,m,v,I,S,E,L="[x]"===n.text.substr(0,3),C=t(),T=C.getContext("2d"),k=t(),O=k.getContext("2d"),A=L?n.text.substr(3):n.text,N=0,R=0,F=0,P=0,D=0;for(E=A;null!==(S=M.exec(A));)E=E.replace(S[0],S[1]+S[2]+(1===parseInt(S[1],10)?S[3]:S[4]));A=E,o=A.replace(/[\$#_]/g,"").split(/( |\n)/g),e("Rendering body: "+A),m=390,v=860,C.width=520,C.height=290,k.width=520,"SPELL"===n.type&&(C.width=460,C.height=290,k.width=460),"WEAPON"===n.type&&(C.width=470,C.height=250,k.width=470);var B=b.settings.bodyFontSize,W=b.settings.bodyLineHeight,H=n.text.replace(/<\/*.>/g,"").length,z=!1;for(H>=80&&(B=.9*b.settings.bodyFontSize,W=.9*b.settings.bodyLineHeight),H>=100&&(B=.8*b.settings.bodyFontSize,W=.8*b.settings.bodyLineHeight),k.height=W,H>=75&&"SPELL"===n.type&&(z=!0),s&&(z=!0),"WEAPON"===n.type?O.fillStyle="#fff":O.fillStyle="#000",O.textBaseline="hanging",O.font=B+'px/1em "'+b.settings.bodyFont+'", sans-serif',y=3,f=0;f<o.length;f++){for(d=o[f],h=d.split(""),c=O.measureText(d).width,e("Next word: "+d),!L&&(N+c>k.width||z&&N+c>.8*k.width)&&(e(N+c+" > "+k.width),e("Calculated line break"),z=!1,D++,p=g(T,k,O,N,R,C.width),N=p[0],R=p[1],I=!0),x=0;x<h.length;x++)if(w=h[x],e(w+" "+w.charCodeAt(0)),10!==w.charCodeAt(0))I=!1,"<"!==w?(O.fillText(w,N+b.settings.bodyFontOffset.x,b.settings.bodyFontOffset.y),N+=O.measureText(w).width+y/8):("/"===h[x+1]?("b"===h[x+2]&&(F--,x+=3),"i"===h[x+2]&&(P--,x+=3)):("b"===h[x+1]&&(F++,x+=2),"i"===h[x+1]&&(P++,x+=2)),O.font=(F>0?"bold ":"")+(P>0?"italic":"")+" "+B+'px/1em "'+b.settings.bodyFont+'", sans-serif');else{if(I){I=!1;continue}D++,p=g(T,k,O,N,R,C.width),N=p[0],R=p[1],e("Manual line break")}N+=y}if(D++,g(T,k,O,N,R,C.width),r(k),"SPELL"===n.type&&4===D&&!z&&!s)return void u(i,a,n,!0);var G=l(T);G.h=Math.ceil(G.h/k.height)*k.height,i.drawImage(C,G.x,G.y-2,G.w,G.h,(m-G.w/2)*a,(v-G.h/2)*a,G.w*a,(G.h+2)*a),r(C),b.settings.debug&&(i.save(),i.strokeStyle="green",i.beginPath(),i.rect((m-G.w/2)*a,(v-G.h/2)*a,G.w*a,(G.h+2)*a),i.stroke(),i.strokeStyle="red",i.beginPath(),i.rect((m-C.width/2)*a,(v-C.height/2)*a,C.width*a,(C.height+2)*a),i.stroke(),i.restore())}function w(e,t){var r,i,a,n;return r=3*Math.pow(1-t,2)*(e[1].x-e[0].x)+6*(1-t)*t*(e[2].x-e[1].x)+3*Math.pow(t,2)*(e[3].x-e[2].x),i=3*Math.pow(1-t,2)*(e[1].y-e[0].y)+6*(1-t)*t*(e[2].y-e[1].y)+3*Math.pow(t,2)*(e[3].y-e[2].y),a=Math.pow(1-t,3)*e[0].x+3*Math.pow(1-t,2)*t*e[1].x+3*(1-t)*Math.pow(t,2)*e[2].x+Math.pow(t,3)*e[3].x,n=Math.pow(1-t,3)*e[0].y+3*Math.pow(1-t,2)*t*e[1].y+3*(1-t)*Math.pow(t,2)*e[2].y+Math.pow(t,3)*e[3].y,{x:a,y:n,r:Math.atan2(i,r)}}function c(e,i,a){var n=t(),s=a.title;n.width=1024,n.height=200;var o=n.getContext("2d");o.save();var l=.58,d=580,h=[{x:0,y:110},{x:102,y:137},{x:368,y:16},{x:580,y:100}];"SPELL"===a.type&&(l=.52,d=580,h=[{x:10,y:100},{x:212,y:35},{x:368,y:35},{x:570,y:105}]),"WEAPON"===a.type&&(l=.58,d=580,h=[{x:10,y:75},{x:50,y:75},{x:500,y:75},{x:570,y:75}]);var g=51;o.lineWidth=13,o.strokeStyle="black",o.lineCap="round",o.lineJoin="round",o.textAlign="left",o.textBaseline="middle";for(var u,c,y=d+1;y>d&&g>10;){g-=1,o.font=g+"px Belwe",y=0;for(var f=0;f<s.length;f++)y+=o.measureText(s[f]).width+2;y*=1.25}y/=d,c=l-y/2,u=y/s.length,b.settings.debug&&(o.save(),o.strokeStyle="red",o.lineWidth=5,o.beginPath(),o.moveTo(h[0].x,h[0].y),o.bezierCurveTo(h[1].x,h[1].y,h[2].x,h[2].y,h[3].x,h[3].y),o.stroke(),o.restore());var x,p,m,v=0;for(f=0;f<s.length;f++){if(0===v)p=c+u*f,x=w(h,p),v=x.x;else for(p+=.01,x=w(h,p);x.x<v;)p+=.001,x=w(h,p);o.save(),o.translate(x.x,x.y),o.scale(1.2,1),o.rotate(x.r),o.lineWidth=10*(g/50),o.strokeStyle="black",o.fillStyle="black",o.fillText(s[f],0,0),o.strokeText(s[f],0,0),m=1.25*o.measureText(s[f]).width,v+=m,-1!==["i","f"].indexOf(s[f])&&(v+=.1*m),o.fillStyle="white",o.strokeStyle="white",o.lineWidth=2.5*(g/50),o.fillText(s[f],0,0),o.restore()}e.drawImage(n,0,0,580,200,105*i,525*i,580*i,200*i),r(n)}function y(r,i,n,o,l,g){var w,y,f=n.sunwell,x=0,p=Date.now();y=setTimeout(function(){e("Drawing timeout at point "+x+" in "+n.title),e(n),g(),l&&l(r)},5e3),"string"==typeof n.texture?w=a(n.texture):n.texture instanceof Image?w=n.texture:(w=t(),w.width=n.texture.crop.w,w.height=n.texture.crop.h,function(){var e=w.getContext("2d");e.drawImage(n.texture.image,n.texture.crop.x,n.texture.crop.y,n.texture.crop.w,n.texture.crop.h,0,0,w.width,w.height)}()),w||(w=a("~")),x=2,i.save(),i.clearRect(0,0,r.width,r.height),x=3,i.save(),"MINION"===n.type&&(s(i,180*o,75*o,430*o,590*o),i.clip(),i.fillStyle="grey",i.fillRect(0,0,765*o,1100*o),i.drawImage(w,0,0,w.width,w.height,100*o,75*o,590*o,590*o)),"SPELL"===n.type&&(i.rect(125*o,165*o,529*o,434*o),i.clip(),i.fillStyle="grey",i.fillRect(0,0,765*o,1100*o),i.drawImage(w,0,0,w.width,w.height,125*o,117*o,529*o,529*o)),"WEAPON"===n.type&&(s(i,150*o,135*o,476*o,468*o),i.clip(),i.fillStyle="grey",i.fillRect(0,0,765*o,1100*o),i.drawImage(w,0,0,w.width,w.height,150*o,135*o,476*o,476*o)),i.restore(),x=4,i.drawImage(a(f.cardBack),0,0,764,1100,0,0,r.width,r.height),x=5,n.costHealth?(i.drawImage(a("health"),0,0,167,218,24*o,62*o,167*o,218*o),i.save(),i.shadowBlur=50*o,i.shadowColor="#FF7275",i.shadowOffsetX=1e3,i.globalAlpha=.5,i.drawImage(a("health"),0,0,167,218,24*o-1e3,62*o,167*o,218*o),i.restore()):i.drawImage(a("gem"),0,0,182,180,24*o,82*o,182*o,180*o),x=6,"MINION"===n.type&&(f.rarity&&i.drawImage(a(f.rarity),0,0,146,146,326*o,607*o,146*o,146*o),i.drawImage(a("title"),0,0,608,144,94*o,546*o,608*o,144*o),n.race&&i.drawImage(a("race"),0,0,529,106,125*o,937*o,529*o,106*o),i.drawImage(a("attack"),0,0,214,238,0,862*o,214*o,238*o),i.drawImage(a("health"),0,0,167,218,575*o,876*o,167*o,218*o),"LEGENDARY"===n.rarity&&i.drawImage(a("dragon"),0,0,569,417,196*o,0,569*o,417*o)),x=7,"SPELL"===n.type&&(f.rarity&&i.drawImage(a(f.rarity),0,0,149,149,311*o,607*o,150*o,150*o),i.drawImage(a("title-spell"),0,0,646,199,66*o,530*o,646*o,199*o)),"WEAPON"===n.type&&(f.rarity&&i.drawImage(a(f.rarity),0,0,146,144,315*o,592*o,146*o,144*o),i.drawImage(a("title-weapon"),0,0,660,140,56*o,551*o,660*o,140*o),i.drawImage(a("swords"),0,0,312,306,32*o,906*o,187*o,183*o),i.drawImage(a("shield"),0,0,301,333,584*o,890*o,186*o,205*o)),x=8,"CORE"!==n.set&&!function(){var e;"SPELL"===n.type&&(e=265),"MINION"===n.type&&(e=265),n.race&&"MINION"===n.type?i.drawImage(a(f.bgLogo),0,0,281,244,e*o,734*o,266.95*o,244*.95*o):"SPELL"===n.type?i.drawImage(a(f.bgLogo),0,0,281,244,e*o,740*o,253*o,220*o):i.drawImage(a(f.bgLogo),0,0,281,244,e*o,734*o,281*o,244*o)}(),x=9,x=10,h(i,116,170,o,n.cost||0,170,n.costStyle),x=11,c(i,o,n),x=12,"MINION"===n.type&&(n.race&&d(i,o,n),h(i,128,994,o,n.attack||0,150,n.attackStyle),h(i,668,994,o,n.health||0,150,n.healthStyle)),x=13,"WEAPON"===n.type&&(h(i,128,994,o,n.attack||0,150,n.attackStyle),h(i,668,994,o,n.durability||0,150,n.durabilityStyle)),x=14,n.silenced&&"MINION"===n.type?i.drawImage(a("silence-x"),0,0,410,397,200*o,660*o,410*o,397*o):u(i,o,n),i.restore(),clearTimeout(y),e("Rendertime: "+(Date.now()-p)+"ms"),g(),l&&l(r)}function f(e,t,r){S.push([e,t,r]),L||x()}function x(){I&&(p(),window.requestAnimationFrame(x))}function p(){if(!(L>E)){var i,a,n;if(S.length){var s=S.shift();L++,i=s[0],a=s[1],n=s[2],e("Preparing assets for: "+i.title);var l=t(),d=l.getContext("2d"),h=(a||512)/764,g=["silence-x"];l.width=a||512,l.height=Math.round(1.4397905759*l.width),i.sunwell=i.sunwell||{},i.sunwell.cardBack=i.type.substr(0,1).toLowerCase()+i.playerClass.substr(0,1)+i.playerClass.substr(1).toLowerCase(),g.push(i.sunwell.cardBack),g.push("gem"),"MINION"===i.type&&(g.push("attack","health","title"),"LEGENDARY"===i.rarity&&g.push("dragon"),"FREE"===i.rarity||"COMMON"===i.rarity&&"CORE"===i.set||(i.sunwell.rarity="rarity-"+i.rarity.toLowerCase(),g.push(i.sunwell.rarity))),"SPELL"===i.type&&(g.push("attack","health","title-spell"),"FREE"===i.rarity||"COMMON"===i.rarity&&"CORE"===i.set||(i.sunwell.rarity="spell-rarity-"+i.rarity.toLowerCase(),g.push(i.sunwell.rarity))),"WEAPON"===i.type&&(g.push("swords","shield","title-weapon"),"FREE"===i.rarity||"COMMON"===i.rarity&&"CORE"===i.set||(i.sunwell.rarity="weapon-rarity-"+i.rarity.toLowerCase(),g.push(i.sunwell.rarity))),-1===["BRM","GVG","LOE","NAX","TGT","OG"].indexOf(i.set)?i.sunwell.bgLogo="bg-cl":i.sunwell.bgLogo="bg-"+i.set.toLowerCase(),"SPELL"===i.type&&(i.sunwell.bgLogo="spell-"+i.sunwell.bgLogo),g.push(i.sunwell.bgLogo),i.race&&g.push("race"),"string"==typeof i.texture&&"CHEAT"!==i.set&&(.5>=h?g.push("h:"+i.texture):g.push("t:"+i.texture)),e("Assets prepared, now loading"),o(g).then(function(){e("Assets loaded for: "+i.title),y(l,d,i,h,n,function(){L--,e("Card rendered: "+i.title),r(l)})})}}}var b,m,v={},I=!1,S=[],E=12,L=0,C={},T=[],M=/(\d+)(.+?)\|4\((.+?),(.+?)\)/g,k=["COMMON","RARE","EPIC","LEGENDARY"];window.sunwell=b=window.sunwell||{},b._buffers=T,b._renderQuery=S,b._activeRenders=L,b.settings=b.settings||{},b.settings.titleFont=b.settings.titleFont||"Belwe Bold",b.settings.bodyFont=b.settings.bodyFont||"ITC Franklin Condensed",b.settings.bodyFontSize=b.settings.bodyFontSize||60,b.settings.bodyFontOffset=b.settings.bodyFontOffset||{x:0,y:0},b.settings.bodyLineHeight=b.settings.bodyLineHeight||50,b.settings.assetFolder=b.settings.assetFolder||"/assets/",b.settings.textureFolder=b.settings.textureFolder||"/artwork/",b.settings.smallTextureFolder=b.settings.smallTextureFolder||null,b.settings.autoInit=b.settings.autoInit||!0,b.settings.idAsTexture=b.settings.idAsTexture||!1,b.settings.debug=b.settings.debug||!1,b.init=function(){I=!0,S.length&&x()},b.settings.autoInit||b.init(),b.races={enUS:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Beast",DEMON:"Demon",PIRATE:"Pirate",DRAGON:"Dragon",TOTEM:"Totem"},deDE:{MURLOC:"Murloc",MECHANICAL:"Mech",BEAST:"Wildtier",DEMON:"DÃ¤mon",PIRATE:"Pirat",DRAGON:"Drache",TOTEM:"Totem"}},b.clearCache=function(){C={}},b.createCard=function(t,r,i){if(!t)throw new Error("No card object given");i||(i=new Image),-1===k.indexOf(t.rarity)&&(t.rarity="FREE"),void 0===t.title&&(t.title=t.name),void 0===t.gameId&&(t.gameId=t.id),b.settings.idAsTexture&&(t.texture=t.gameId),t.costStyle=t.costStyle||"0",t.healthStyle=t.healthStyle||"0",t.attackStyle=t.attackStyle||"0",t.durabilityStyle=t.durabilityStyle||"0",t.silenced=t.silenced||!1,t.costHealth=t.costHealth||!1,t.width=r;var a=n(t);return C[a]&&!b.settings.debug?void(i.src=C[a]):(e("Queried render: "+t.title),f(t,r,function(e){i.src=C[a]=e.toDataURL()}),{target:i,redraw:function(){a=n(t),delete C[a],f(t,r,function(e){i.src=C[a]=e.toDataURL()})},update:function(e){for(var s in e)t[s]=e[s];return a=n(t),C[a]?void(i.src=C[a]):void f(t,r,function(e){i.src=C[a]=e.toDataURL()})}})}}();